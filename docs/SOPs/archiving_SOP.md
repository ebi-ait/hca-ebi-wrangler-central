---
layout: default
title: Archiving SOP
parent: SOPs
---
<script src="https://kit.fontawesome.com/fc66878563.js" crossorigin="anonymous"></script>

# Archiving instructions
{: .no_toc }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}


## Submission flow

<div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile modified=\&quot;2020-10-08T10:02:52.902Z\&quot; host=\&quot;app.diagrams.net\&quot; agent=\&quot;5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\&quot; etag=\&quot;TGxY6hbfhD0oZjNWSy-V\&quot; version=\&quot;13.7.5\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;JDNivFf4d52t-QeiXBCF\&quot; name=\&quot;Page-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>


<div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2021-08-10T05:57:25.844Z\&quot; agent=\&quot;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36\&quot; etag=\&quot;Q4mGB-0szvxUP43B32ot\&quot; version=\&quot;14.9.5\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;eq_zboOWMmhzdJX9u9c9\&quot; name=\&quot;Page-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>

## Submit for Archiving

1. Once the data files are uploaded, the submission should be listed as **Valid.**
2. On the _Submit_ tab, click the Submit Button.
3. The submission will be marked as **Processing** as it maps the experimental graph
4. Once finished, the submission will be marked as: **Archiving**
    1. **Please now poke your #hca-operations buddies to continue the process below by Archiving the Metadata to DSP.**


## Step 1 of 3 - Archiving Metadata to DSP

### Before using the service 

Please note when using the documentation below:


*   There is a difference between **api**.ingest… and **archiver**.ingest…
    * API -> **ingest_submission_uuid**
    * Archiver -> **dsp_submission_uuid**
*   Obtain and replace `{archiver_api_key}` with the key obtained by running the following cmd (replace `dev` with `staging` or `prod` depending on the environment):
    *   specify if prod/staging/dev
        ```
         aws --region us-east-1 secretsmanager get-secret-value --secret-id ingest/archiver/wrangler/secrets --query SecretString --output text | jq -jr .prod_archiver_api_key
        ``` 
    *   If you can't retrieve the archiver service api key using this command, it is likely because you do not have the required permissions. Ask a dev or wrangler to obtain the key


### Archiver endpoints
There are currently 3 environments that you can use for the archiver:

1. `https://archiver.ingest.dev.archive.data.humancellatlas.org`: Corresponding to **DSP test environment**
1. `https://archiver.ingest.staging.archive.data.humancellatlas.org`: Corresponding to **DSP test environment**
1. `https://archiver.ingest.archive.data.humancellatlas.org`: Corresponding to **DSP production environment**

Please make sure you are using the proper endpoint when archiving (Instruction and examples written for the staging environment)


### Using the service

Once a submission is ready in ingest (`Archiving` status after hitting submit), you need to follow the next steps:

1. Open a terminal

1. Create a DSP submission given an ingest submission UUID with a POST request
   ```
   curl -X POST https://archiver.ingest.staging.archive.data.humancellatlas.org/archiveSubmissions -H 'Content-Type: application/json' -H 'Api-Key: {archiver_api_key}' -d '{"submission_uuid": "{ingest_submission_uuid}", "alias_prefix": "HCA"}'
   ```
   Please note this is an async request and even if it's successfully triggered (You will get a response saying that), it may take a while to create the submission.
   
1. Retrieve the DSP submission UUID via the ingest submission UUID
   ```
   curl -X GET  -H 'Api-Key: {archiver_api_key}' https://archiver.ingest.staging.archive.data.humancellatlas.org/latestArchiveSubmission/<ingest_submission_uuid>
   ```
   This request should give you the UUID in the json response

#### Useful requests to check DSP submission

*  **Check validation errors**
   ```
   curl -X GET https://archiver.ingest.staging.archive.data.humancellatlas.org/archiveSubmissions/<dsp_submission_uuid>/validationErrors -H 'Api-Key: {archiver_api_key}' 
   ```

*  **Check any submission blockers**
   ```
   curl -X GET https://archiver.ingest.staging.archive.data.humancellatlas.org/archiveSubmissions/<dsp_submission_uuid>/blockers -H 'Api-Key: {archiver_api_key}' 
   ```


### Notes
- There is another way to run the archiver, through the CLI. This should be used as a last resort as it's getting deprecated. Please contact a dev to use the CLI instead of the web service.
- Please contact a dev if there is any problem with the metadata. We currently have no way to update it through the UI so it needs to be updated manually in DSP.


## Step 2 of 3 - Archiving Files to DSP

_Note: When direct archiving is fully functional, the instructions at the end of this step on __Uploading files directly to ENA__ should be followed instead of the following._

Once the metadata is in DSP, the next step is to upload the files.

### Before you start
Please contact a developer for the AAP username and password. These are unique per environment, so make sure to state if you are using the `prod` or `test` environment.

### File Upload Info

#### What it is
The file upload info is a JSON file that provides the file archiver component of ingest with the information needed to convert/upload the files from the submission to DSP.

Its structure is:


```
{
    "jobs": [
        {
            "dsp_api_url": "<dsp_api_url>",
            "ingest_api_url": "https://api.ingest[.staging].archive.data.humancellatlas.org",
            "submission_url": "<submission_url_with_id>",
            "dcp_bundle_uuid": "<dcp_bundle_uuid>",
            "files": [
                {
                   "name": "<name_of_output_bamfile>"
                }
            ],
            "manifest_id": "<bundle_manifest_id>",
            "conversion": {
                "output_name": "<name_of_output_bamfile>",
                "schema": "[10xV2, 10xV3]"
                "inputs": [
                    {
                        "name": "<r1_fastq_filename>",
                        "read_index": "read1",
                        "cloud_url": "<complete_s3_read1_url>"
                    },
                    {
                        "name": "<r2_fastq_filename>",
                        "read_index": "read2",
                        "cloud_url": "<complete_s3_read2_url>"
                    },
                    {
                        "name": "<i1_fastq_filename>",
                        "read_index": "index1",
                        "cloud_url": "<complete_s3_index1_url>"
                    }
                ]
            }
        }
    ]
}
```


<**dsp_api_url**>


- https://submission.ebi.ac.uk/api/ -> production

- https://submission-test.ebi.ac.uk/api/ -> staging

<**submission_url_with_id**>

`dsp_api_url>/submissions/&lt;submission_id>`

<**dcp_bundle_uuid**>

This field will only be added when trying to archive a DCP1 dataset.

<**name_of_output_bamfile**>

Free string but usually bundle manifest ID + “.bam”

<**schema**>

Either 10xV2 or 10xV3. The toolset used for BAM conversion ([fastq2bam](https://github.com/nunofonseca/fastq_utils#fastq2bam---lossless-fastq-to-bam-convertor)) currently does not support some schemas, such as e.g. SS2.

<**rx_fastq_filename**>

Filename of the fastq file

<**complete_s3_xxxx_url**>

URL where the archiver can find the file. Has to be an s3 (e.g. s3://mock-upload-area-prefix/abcd-abcd-abcd-abcd/filename.fastq.gz) and you should be able to download files with the credentials that you provide later.


The “conversion” field can be deleted if no bam conversion is needed. It won't be generated unless conversion is needed.


### Using the file archiver service

Please make sure that all commands using the File Archiver image is pointing to the latest version of it.
Check latest image version (prod released version will have the tag format `dYYYY-DD-MM.<increment_digit>`) in [quay.io](https://quay.io/repository/ebi-ait/ingest-file-archiver?tab=tags)

#### Using EBI Cluster

As a standard, we run bam conversion in the EBI cluster, as it may need a big chunk of memory and fail when ran in the EC2. Steps to use:

1. Login to VPN if offsite, using pulse secure or other (EBI macbooks have Pulse Secure pre-installed for this)

1. Login to cluster
   ```
   ssh ebi-cli.ebi.ac.uk
   ```

1. Move to the folder you want to run the jobs from and create the folder if necessary
   ```
   cd /nfs/production/hca/<shortname_of_project>/
   ```
   Please note that the archiver service **does not** create the folder for you. The first time you head there you'll need to first create it
   ```
   mkdir /nfs/production/hca/<shortname_of_project>/
   ```
   All fastq files will be downloaded here, and the bams will be generated under this folder as well

1. Make a request to the Archiver service endpoint to retrieve File Upload Info JSON file
   ```
   curl -X GET https://archiver.ingest.staging.archive.data.humancellatlas.org/archiveSubmissions/<dsp_submission_uuid>/fileUploadPlan  -H 'Api-Key: {archiver_api_key}' > /nfs/production/hca/<folder_name>/<file_name>.json
   ```

Once the file_upload_info.json is in the folder, you have 2 options:
1. **Run the job sequentually**: Running the singularity job with 64GB memory (Default is 1GB)
    ```
    bsub -J <job_name> -M 64000 'singularity run -B /nfs/production/hca/<folder_name>:/data docker://quay.io/ebi-ait/ingest-file-archiver:d2020-30-09.1 -d=/data -f=/data/<file_name>.json -l=https://explore.api.aai.ebi.ac.uk/auth -u=<aap-username> -p=<aap-password> -a=<aws-key> -s="<aws-secret>"'
    ```
1. **Run the job in parallel**: Please refer to the [next subsection](#run-parallel-jobs) to run the file archiver in parallel.

##### Run parallel jobs

With only one file_upload_info.json, all jobs are run sequentially. In order to run parallel jobs, you need to use a script to divide the jobs and send each one of the jobs as a different job in the cluster. Assuming you are already logged in the cluster, and in the working directory, the steps are:

1. Verify that you can use python version 3.7 or above
   ```
   python --version
   Python 3.7.8
   ```
   **Note**:If python version is not 3.7, you could use pyenv (you must install it first) to install specific python version
   ```
   pyenv install 3.7.8
   pyenv global 3.7.8
   python --version
   Python 3.7.8
   ```

1. Clone the [repo](https://github.com/ebi-ait/hca-ebi-dev-team) where the batch script is located and setup a virtual env to run the script

   ```
   git clone https://github.com/ebi-ait/hca-ebi-dev-team.git
   cd hca-ebi-dev-team/scripts/batch_file_archiver/
   pip install virtualenv
   virtualenv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

1. Download the file upload plan if you haven't already

1. Run the python script to batch file archiver jobs. You could do a dry run first and see the bsub job commands to run. Remove the --dry_run flag if you think the bsub commands are correct.

   ```
   python batch_file_archiver.py '<aap-user>' '<aap-password>' '<aws-key>' '<aws-key-secret>'  '/nfs/production/hca/<work-dir>' './FILE_UPLOAD_INFO_953b4f03-f5d3-4a03-ad48-6aa125bacf1f.json' <--dry_run>
   ```

Note: Please make sure the `batch_file_archiver.py` is pointing to the latest version of the File Archiver. (See details [Using the file archiver service](### Using the file archiver service) on how to check latest version)
If not please update this file in GitHub to point it to use the new version.

#### Using Wrangler EC2

If no BAM conversion is required, you can use the wrangler EC2 as follows:

1. Send info file to EC2 home directory

   ```
   scp FILE_UPLOAD_INFO.json <user>@tool.archive.data.humancellatlas.org:./
   ```
   
1. Connect to the wrangler EC2
   ```
   ssh <user>@tool.archive.data.humancellatlas.org
   ```

1. Create a background task screen

   ```
   screen -S <optional_session_name>
   ```
    1. [More info about the screen command](https://linuxize.com/post/how-to-use-linux-screen/#detach-from-linux-screen-session).

1. Run the file archiver

    ```
    docker run \
    -v $PWD:/data \
    --env BASE_DIR=/data \
    --env UPLOAD_PLAN_PATH=/data/FILE_UPLOAD_INFO.json \
    --env AAP_USERNAME=<aap_user> \
    --env AAP_PASSWORD=<aap_password> \
    --env AAP_URL=https://explore.api.aai.ebi.ac.uk/auth \
    --env AWS_ACCESS_KEY_ID=<aws_key> \
    --env AWS_SECRET_ACCESS_KEY=<aws_secret> \
    quay.io/ebi-ait/ingest-file-archiver:d2020-30-09.1
    ```


1. Disconnect from your screen, leaving your session running
    ```
    CTRL+A, CTRL+D
    ```
    1. You can now close your terminal, leaving the upload running
    
    
1. Reconnect to your screen
    ```
    screen -r <optional_session_name>
    ```

#### Checking files have been uploaded

To check if the files have been uploaded:

* **EC2**: Just reconnect to your session and check stdout
* **EBI Cluster**: Check how many jobs you have currently running:
  ```
  bjobs -W
  ```
  This will give you the list of jobs that are currently pending or running. If you have any questions, please contact the devs for a more detailed log.
  
If the file-archiver/all jobs in the cluster have finished, an indirect way to check if everything went correctly is to check for validation errors:
```
curl -X GET https://archiver.ingest.archive.data.humancellatlas.org/archiveSubmissions/<dsp_submission_uuid>/validationErrors -H 'Api-Key: {archiver_api_key}' 
```
Once all the files are uploaded, you should get no validation errors. If there are, please contact a dev to check what happened.


### Example Showing File and Folder Locations

In the above commands, it is recommended that you use `/nfs/production/hca/` as your root folder. Create directories inside of here to manage your uploads to DSP, a directory per HCA project is sufficient and they can be called whatever you want, (often HCA project UUIDs). Using one folder per project means less re-downloading of files since they are cached in the data directory by manifest ID and re-used.

Matching these locations in your commands is really important. In the following example



*   `<folder_root>` = /nfs/production/hca/
*   `<folder_name>` = laurenti
*   `<file_name>` = upload_info.json
*   `<dsp_submission_uuid>` = 1234
*   `<job_name>` = laurenti_upload
*   Using the live ingest environment
*   Please note that /data is fixed, in theory you could change it, but please don’t.
*   In theory you could also change the docker image you pull to use specific versions of file archiver but again, please don’t: `docker://quay.io/ebi-ait/ingest-file-archiver:d2020-30-09.1`

Download the the file upload info:


```
curl -X GET https://archiver.ingest.archive.data.humancellatlas.org/archiveSubmissions/1234/fileUploadPlan  -H 'Api-Key: {archiver_api_key}' > /nfs/production/hca/laurenti/upload_info.json
```


Trigger the File Transfer to DSP:


```
bsub -J laurenti_upload -M 64000 'singularity run -B /nfs/production/hca/laurenti:/data docker://quay.io/ebi-ait/ingest-file-archiver:d2020-30-09.1 -d=/data -f=/data/upload_info.json -l=https://api.aai.ebi.ac.uk/auth -u=hca-ingest -p=<aap-password> -a=<aws-key> -s=<aws-secret>'
```


If running parallel jobs, choose different <file_name> / <job_names> because you will have multiple file-upload-infos and multiple jobs, in this case I’ve used the name of the output bam file as the job_name and file_name.


### Uploading files directly to ENA

This is a much simplified flow and only requires the user to trigger data files archiving by sending a HTTP POST request to a new endpoint in `ingest-archiver`. The request bypasses DSP and uploads files directly to ENA.

Trigger data archiving endpoint:
```
{INGEST_ARCHIVER_URL}/archiveSubmissions/data
```

Example usage in the terminal:
```
curl -X POST {INGEST_ARCHIVER_URL}/archiveSubmissions/data -H 'Content-Type: application/json' -H "Api-Key:{ARCHIVER_API_KEY}" -d '{"sub_uuid": "{SUB_UUID}"}'
```
- `INGEST_ARCHIVER_URL` See the Archiver endpoints section in Step 1 above.
- `ARCHIVER_API_KEY` See how to obtain the archiver API key in Step 1 above.
- `SUB_UUID` The submission uuid.

The README of the [ingest-data-archiver](https://github.com/ebi-ait/ingest-data-archiver) contains more examples of the valid requests, including with the `files` property which permits the user to specify individual data file(s) of a particular submission instead of the default (without `files` property) where all files of the submission are archived.


# Step 3 of 3 - Complete DSP Submission

Once the files are uploaded and validated, to finish the submission, just run the following request to complete the submission:
```
curl -X POST https://archiver.ingest.staging.archive.data.humancellatlas.org/archiveSubmissions/<dsp_submission_uuid>/complete -H 'Api-Key: {archiver_api_key}' 
```
